
# 0. 예제 데이터 ---------------------------------------------------------------

# 메타 분석을 위한 패키지 로드
library(meta)

# 여론조사 데이터 입력 (예시)
study <- c("Survey 1", "Survey 2", "Survey 3", "Survey 4", "Survey 5")
n1 <- c(500, 600, 550, 700, 800)  # 후보 1의 표본 크기
n2 <- c(500, 600, 550, 700, 800)  # 후보 2의 표본 크기
p1 <- c(0.45, 0.50, 0.48, 0.52, 0.55)  # 후보 1의 지지율
p2 <- c(0.40, 0.42, 0.44, 0.46, 0.48)  # 후보 2의 지지율

# 각 여론조사의 효과 크기 (차이) 및 분산 계산
diff <- p1 - p2
var_diff <- p1*(1-p1)/n1 + p2*(1-p2)/n2

# 메타분석 수행
meta_result <- metagen(TE = diff, seTE = sqrt(var_diff), studlab = study, sm = "MD", fixed = FALSE, random = TRUE)

# 메타분석 결과 출력
print(summary(meta_result))

# 메타분석 결과 시각화 (포리스트 플롯)
forest(meta_result, xlim = c(-0.2, 0.2), atransf = FALSE, slab = study, comb.fixed = TRUE, comb.random = TRUE)

# 1. 계양구을 -------------------------------------------------------------
# 1.1. meta ---------------------------------------------------------------

# 메타 분석을 위한 패키지 로드
library(meta)

# 데이터 입력
data <- data.frame(
 study = c("펜앤드마이크리서치앤리서치, 여론조사공정", "여론조사꽃여론조사꽃", "인천일보한길리서치", "뉴스토마토미디어토마토", "KBS한국리서치", "경인일보KSOI", "뉴스1한국갤럽", "KBS한국리서치", "TV조선, 조선일보케이스탯리서치", "YTN엠브레인퍼블릭", "JTBC메타보이스", "중앙일보한국갤럽", "MBC코리아리서치", "KBC광주방송, UPI뉴스리서치뷰", "뉴스토마토미디어토마토", "MBN, 매일경제신문넥스트리서치", "KBS한국리서치", "서울경제신문한국갤럽", "OBS경인TV케이스탯리서치", "동아일보리서치앤리서치", "뉴스핌미디어리서치", "뉴스1한국갤럽", "KBS한국리서치", "CBSKSOI", "기호일보KOPRA", "인천일보, 경인방송한길리서치", "경기일보미디어리서치"),
 n = c(504, 510, 502, 1000, 500, 508, 504, 500, 500, 500, 524, 501, 501, 500, 501, 501, 500, 501, 502, 507, 501, 502, 500, 503, 502, 500, 500),
 p1 = c(48.0, 43.8, 50.7, 49.1, 44.0, 47.8, 45.0, 48.0, 43.0, 42.0, 51.0, 48.0, 50.0, 51.1, 46.6, 48.0, 52.0, 46.0, 48.9, 50.5, 47.2, 46.0, 51.0, 51.6, 51.7, 51.7, 47.7) / 100,
 p2 = c(32.0, 29.8, 34.3, 41.0, 34.0, 43.3, 41.0, 36.0, 35.0, 39.0, 34.0, 40.0, 39.0, 44.8, 41.4, 43.0, 35.0, 40.0, 37.3, 37.5, 43.6, 42.0, 34.0, 40.3, 41.3, 41.8, 44.3) / 100
)

# 각 여론조사의 효과 크기 (차이) 및 분산 계산
data$diff <- data$p1 - data$p2
data$var_diff <- data$p1 * (1 - data$p1) / data$n + data$p2 * (1 - data$p2) / data$n

# 메타분석 수행
meta_result <- metagen(TE = data$diff, seTE = sqrt(data$var_diff), studlab = data$study, sm = "MD", fixed = FALSE, random = TRUE)

# 메타분석 결과 출력
print(summary(meta_result))

# 메타분석 결과 시각화 (포리스트 플롯)
forest(meta_result, xlim = c(-0.2, 0.2), atransf = FALSE, slab = data$study, comb.fixed = TRUE, comb.random = TRUE)

# 1.2. metafor ------------------------------------------------------------

# metafor 패키지 로드
library(metafor)

# 데이터 입력
data <- data.frame(
 study = c("펜앤드마이크리서치앤리서치, 여론조사공정", "여론조사꽃여론조사꽃", "인천일보한길리서치", "뉴스토마토미디어토마토", "KBS한국리서치", "경인일보KSOI", "뉴스1한국갤럽", "KBS한국리서치", "TV조선, 조선일보케이스탯리서치", "YTN엠브레인퍼블릭", "JTBC메타보이스", "중앙일보한국갤럽", "MBC코리아리서치", "KBC광주방송, UPI뉴스리서치뷰", "뉴스토마토미디어토마토", "MBN, 매일경제신문넥스트리서치", "KBS한국리서치", "서울경제신문한국갤럽", "OBS경인TV케이스탯리서치", "동아일보리서치앤리서치", "뉴스핌미디어리서치", "뉴스1한국갤럽", "KBS한국리서치", "CBSKSOI", "기호일보KOPRA", "인천일보, 경인방송한길리서치", "경기일보미디어리서치"),
 n1 = c(504, 510, 502, 1000, 500, 508, 504, 500, 500, 500, 524, 501, 501, 500, 501, 501, 500, 501, 502, 507, 501, 502, 500, 503, 502, 500, 500),
 n2 = c(504, 510, 502, 1000, 500, 508, 504, 500, 500, 500, 524, 501, 501, 500, 501, 501, 500, 501, 502, 507, 501, 502, 500, 503, 502, 500, 500),
 p1 = c(48.0, 43.8, 50.7, 49.1, 44.0, 47.8, 45.0, 48.0, 43.0, 42.0, 51.0, 48.0, 50.0, 51.1, 46.6, 48.0, 52.0, 46.0, 48.9, 50.5, 47.2, 46.0, 51.0, 51.6, 51.7, 51.7, 47.7) / 100,
 p2 = c(32.0, 29.8, 34.3, 41.0, 34.0, 43.3, 41.0, 36.0, 35.0, 39.0, 34.0, 40.0, 39.0, 44.8, 41.4, 43.0, 35.0, 40.0, 37.3, 37.5, 43.6, 42.0, 34.0, 40.3, 41.3, 41.8, 44.3) / 100
)

# 각 여론조사의 효과 크기 (로짓 변환된 비율 차이) 및 분산 계산
data$yi <- log(data$p1 / (1 - data$p1)) - log(data$p2 / (1 - data$p2))
data$vi <- 1 / (data$n1 * data$p1 * (1 - data$p1)) + 1 / (data$n2 * data$p2 * (1 - data$p2))

# 메타분석 수행 (랜덤 효과 모델)
meta_result <- rma(yi, vi, data = data, method = "REML")

# 메타분석 결과 출력
print(summary(meta_result))

# 메타분석 결과 시각화 (포리스트 플롯)
forest(meta_result, slab = data$study, xlim = c(-1.5, 1.5), atransf = exp, at = log(c(0.25, 0.5, 1, 2, 4)), digits = 2)

# Forest plot with proportions
# forest(meta_result, slab = data$study, xlim = c(-0.2, 0.4), atransf = transf.ipft.hm, at = seq(-0.2, 0.4, 0.1), digits = 2, targs = list(ni = data$n1, ri = data$n1 * data$p1))

# 2. 마무리 ------------------------------------------------------------------

# 1. 계양구을 -------------------------------------------------------------
# 1.1. meta ---------------------------------------------------------------

# 메타 분석을 위한 패키지 로드
library(meta)

# 데이터 입력
data <- data.frame(
 study = c("펜앤드마이크리서치앤리서치, 여론조사공정", "여론조사꽃여론조사꽃", "인천일보한길리서치", "뉴스토마토미디어토마토", "KBS한국리서치", "경인일보KSOI", "뉴스1한국갤럽", "KBS한국리서치", "TV조선, 조선일보케이스탯리서치", "YTN엠브레인퍼블릭", "JTBC메타보이스", "중앙일보한국갤럽", "MBC코리아리서치", "KBC광주방송, UPI뉴스리서치뷰", "뉴스토마토미디어토마토", "MBN, 매일경제신문넥스트리서치", "KBS한국리서치", "서울경제신문한국갤럽", "OBS경인TV케이스탯리서치", "동아일보리서치앤리서치", "뉴스핌미디어리서치", "뉴스1한국갤럽", "KBS한국리서치", "CBSKSOI", "기호일보KOPRA", "인천일보, 경인방송한길리서치", "경기일보미디어리서치"),
 n = c(504, 510, 502, 1000, 500, 508, 504, 500, 500, 500, 524, 501, 501, 500, 501, 501, 500, 501, 502, 507, 501, 502, 500, 503, 502, 500, 500),
 p1 = c(48.0, 43.8, 50.7, 49.1, 44.0, 47.8, 45.0, 48.0, 43.0, 42.0, 51.0, 48.0, 50.0, 51.1, 46.6, 48.0, 52.0, 46.0, 48.9, 50.5, 47.2, 46.0, 51.0, 51.6, 51.7, 51.7, 47.7) / 100,
 p2 = c(32.0, 29.8, 34.3, 41.0, 34.0, 43.3, 41.0, 36.0, 35.0, 39.0, 34.0, 40.0, 39.0, 44.8, 41.4, 43.0, 35.0, 40.0, 37.3, 37.5, 43.6, 42.0, 34.0, 40.3, 41.3, 41.8, 44.3) / 100
)

# 각 여론조사의 효과 크기 (차이) 및 분산 계산
data$diff <- data$p1 - data$p2
data$var_diff <- data$p1 * (1 - data$p1) / data$n + data$p2 * (1 - data$p2) / data$n

# 메타분석 수행
meta_result <- metagen(TE = data$diff, seTE = sqrt(data$var_diff), studlab = data$study, sm = "MD", fixed = FALSE, random = TRUE)

# 메타분석 결과 출력
print(summary(meta_result))

# 메타분석 결과 시각화 (포리스트 플롯)
forest(meta_result, xlim = c(-0.2, 0.2), atransf = FALSE, slab = data$study, comb.fixed = TRUE, comb.random = TRUE)

extrafont::loadfonts(device = "win")
# 나눔고딕 글꼴 설정
par(family = "MaruBuri")

library(rsvg)

# 메타분석 결과 시각화 (포리스트 플롯)
# tiff("images/forest_plot.tiff", width = 800, height = 600, res = 300)
# svg("images/forest_plot.png", width = 8, height = 6)
png("images/forest_plot.png", width = 8, height = 6)
# pdf("images/forest_plot.pdf", width = 8, height = 6)

# 그래프 여백 조절
par(mar = c(5, 4, 4, 2) + 0.1)

forest(meta_result, xlim = c(-0.2, 0.2), 
       atransf = FALSE,
       slab = data$study, comb.fixed = TRUE, comb.random = TRUE,
       label.left = "국민의힘 지지율 높음",
       label.right = "민주당 지지율 높음", 
       xlab = "지지율 차이",
       smlab = "관측된 지지율 차이",
       text.fixed = "고정 효과 모형",
       text.random = "랜덤 효과 모형",
       leftcols = "studlab",
       leftlabs = "여론조사",
       family = "NanumMyeongjo")

title(main = "제22대 국회의원선거 인천 계양구을",
      sub  = "조사기간: 1월30일 ~ 4월 1일 (27개 여론조사)")

# 그래픽 장치 닫기
dev.off()



