# 코드

## 고정효과분석

R에서 고정효과 모형(Fixed Effects Model)을 사용한 메타 분석을 수행하기 위한 기본적인 코드 템플릿을 제공하겠습니다. 이 코드는 `metafor` 패키지를 사용하는데, 이는 메타 분석을 위한 가장 널리 사용되는 R 패키지 중 하나입니다.

먼저, 필요한 패키지를 설치하고 불러옵니다:

```{r}
# install.packages("metafor")
library(metafor)
```

다음으로, 분석할 데이터를 준비합니다. 여기서는 각 연구의 효과 크기(effect size)와 표준 오차(standard error)를 포함해야 합니다. 예시 데이터를 만들겠습니다:

```{r}
dat <- data.frame(
  study = c("Study1", "Study2", "Study3", "Study4"),
  effect_size = c(0.2, 0.4, 0.6, 0.3),
  se = c(0.1, 0.15, 0.2, 0.1)
)
```

이제 `rma` 함수를 사용하여 고정효과 모형 메타 분석을 수행합니다:

```{r}
res <- rma(yi = effect_size, sei = se, data = dat, method="FE")
```

여기서 `yi`는 효과 크기, `sei`는 표준 오차를 나타냅니다. `method="FE"`는 고정효과 모형을 사용하겠다는 것을 의미합니다.

마지막으로, 결과를 요약하고 시각화합니다:

```{r}
summary(res)  # 결과 요약
forest(res)   # 포레스트 플롯 생성
```

이 코드는 매우 기본적인 템플릿입니다. 실제 연구에서는 데이터의 구조와 필요에 따라 이 코드를 수정하고, 추가적인 분석이나 시각화를 할 수 있습니다. 예를 들어, 연구 간의 이질성을 평가하거나, 각 연구의 가중치를 조정하거나, 서브그룹 분석을 수행할 수도 있습니다.

### 결과 해석

메타 분석 결과에서 제시된 주요 수치들은 다음과 같은 의미를 가지고 있습니다:

1. **고정효과 모형(Fixed-Effects Model)**: 사용된 모형이고, 모든 연구가 동일한 효과 크기를 공유한다고 가정합니다.

2. **logLik, deviance, AIC, BIC, AICc**: 이들은 모형의 적합도를 나타내는 통계적 지표입니다. AIC, BIC, AICc는 모형 선택 기준으로 사용되며, 낮은 값이 더 좋은 모형 적합도를 의미합니다.

3. **I² (18.49%)**: 이질성 통계량으로, 전체 변동 중 이질성이 차지하는 비율을 나타냅니다. 18.49%는 이질성이 낮음을 의미하며, 고정효과 모형이 적절할 수 있음을 시사합니다.

4. **H² (1.23)**: 전체 변동을 표본 변동으로 나눈 값입니다. 1에 가까울수록 연구 간의 이질성이 적음을 의미합니다.

5. **이질성 검정(Q 통계량과 p-값)**: Q(df = 3) = 3.6804, p-val = 0.2981입니다. p-값이 0.05보다 크므로, 연구 간에 유의한 이질성이 없다고 할 수 있습니다.

6. **모형 결과**: 
   - 추정치(estimate): 0.3072는 메타 분석 결과로 얻은 통합 효과 크기입니다.
   - 표준 오차(se): 0.0609로, 추정치의 불확실성을 나타냅니다.
   - Z-값(zval): 5.0429는 통계적 유의성을 검증하는데 사용됩니다.
   - p-값(pval): <.0001로, 이 효과는 통계적으로 매우 유의합니다.
   - 신뢰 구간(ci.lb, ci.ub): 0.1878에서 0.4266 사이, 실제 효과 크기가 이 범위에 있을 것이라고 95% 확신합니다.

이 결과를 종합해보면, 포함된 연구들은 낮은 이질성을 보이며, 통합 효과 크기는 통계적으로 유의하게 0.3072로 추정됩니다. 이는 해당 효과가 실제로 존재하며, 연구들 간의 차이는 크지 않음을 의미합니다.

## 랜덤 효과 모형

R에서 랜덤 효과 모형(Random Effects Model)을 사용한 메타 분석을 수행하기 위한 기본적인 코드 템플릿을 제공하겠습니다. 랜덤 효과 모형은 연구 간에 실제 효과 크기가 다를 수 있다고 가정합니다. 이 모델은 고정 효과 모형보다 더 넓은 범위의 연구 이질성을 고려합니다.

먼저, `metafor` 패키지를 설치하고 불러옵니다:

```{r}
# install.packages("metafor")
library(metafor)
```

다음으로, 분석할 데이터를 준비합니다. 여기서는 각 연구의 효과 크기(effect size)와 표준 오차(standard error)를 포함해야 합니다. 예시 데이터를 만들겠습니다:

```{r}
dat <- data.frame(
  study = c("Study1", "Study2", "Study3", "Study4"),
  effect_size = c(0.2, 0.4, 0.6, 0.3),
  se = c(0.1, 0.15, 0.2, 0.1)
)
```

이제 `rma` 함수를 사용하여 랜덤 효과 모형 메타 분석을 수행합니다:

```{r}
res <- rma(yi = effect_size, sei = se, data = dat, method="REML")
```

여기서 `yi`는 효과 크기, `sei`는 표준 오차를 나타냅니다. `method="REML"`는 제한된 최대 우도(restricted maximum likelihood) 방식을 사용하여 랜덤 효과 모형을 추정하겠다는 것을 의미합니다.

마지막으로, 결과를 요약하고 시각화합니다:

```{r}
summary(res)  # 결과 요약
forest(res)   # 포레스트 플롯 생성
```

이 코드는 랜덤 효과 모형 메타 분석의 기본적인 템플릿을 제공합니다. 실제 연구에서는 데이터의 특성과 분석 목적에 맞게 코드를 조정하고, 필요한 경우 추가적인 분석이나 시각화를 할 수 있습니다.

### 결과 해석

랜덤 효과 모형(Random Effects Model) 메타 분석의 결과를 해석해보겠습니다:

1. **랜덤 효과 모형**: 이 모형은 연구 간에 실제 효과 크기가 다를 수 있음을 가정합니다.

2. **로그 가능도(logLik), 편차(deviance), AIC, BIC, AICc**: 이들은 모형의 적합도를 평가하는 지표입니다. AIC, BIC, AICc는 모형의 상대적 품질을 평가하는 데 사용되며, 낮은 값일수록 더 나은 적합도를 의미합니다.

3. **Tau² (τ²)**: 추정된 전체 이질성의 양입니다. 여기서 τ² = 0.0001 (SE = 0.0120)으로 매우 작은 값을 보이며, 이는 연구 간 이질성이 거의 없음을 나타냅니다.

4. **Tau (τ)**: τ²의 제곱근으로, 연구 간 이질성의 크기를 나타냅니다. 여기서 τ = 0.0079입니다.

5. **I² (0.38%)**: 이질성의 비율을 나타내며, 전체 변동 중 이질성이 차지하는 부분입니다. 0.38%는 매우 낮은 이질성을 의미합니다.

6. **H² (1.00)**: 전체 변동을 표본 변동으로 나눈 값입니다. 1에 가까운 값은 연구 간 이질성이 적음을 의미합니다.

7. **이질성 검정**: Q(df = 3) = 3.6804, p-val = 0.2981로, 이는 연구 간에 유의한 이질성이 없다는 것을 의미합니다.

8. **모형 결과**:
   - 추정치(estimate): 0.3074는 메타 분석 결과로 얻은 통합 효과 크기입니다.
   - 표준 오차(se): 0.0611로, 추정치의 불확실성을 나타냅니다.
   - Z-값(zval): 5.0327은 통계적 유의성을 검증하는데 사용됩니다.
   - p-값(pval): <.0001로, 이 효과는 통계적으로 매우 유의합니다.
   - 신뢰 구간(ci.lb, ci.ub): 0.1877에서 0.4271 사이, 실제 효과 크기가 이 범위에 있을 것이라고 95% 확신합니다.

이 결과는 연구 간 이질성이 매우 낮음에도 불구하고 랜덤 효과 모형을 적용했음을 나타냅니다. 통합 효과 크기는 0.3074로, 이는 효과가 실제로 존재하며 통계적으로 매우 유의하다는 것을 의미합니다. 이질성이 낮기 때문에, 고정 효과 모형과 랜덤 효과 모형의 결과가 매우 유사합니다.

메타 분석의 랜덤 효과 모형 실행 결과와 관련하여 포레스트 플롯(Forest Plot)을 해석해 드리겠습니다. 포레스트 플롯은 메타 분석 결과를 시각적으로 표현하는 그래프로, 각 연구의 효과 크기와 신뢰 구간을 나타냅니다. 또한 이 그래프는 통합된 효과 크기 및 해당 신뢰 구간도 함께 제시합니다.

포레스트 플롯의 주요 요소는 다음과 같습니다:

1. **연구 이름**: 각 연구를 구별하는 데 사용됩니다.

2. **효과 크기**: 각 연구의 중심점은 해당 연구의 효과 크기를 나타냅니다. 일반적으로, 효과 크기가 0보다 크면 긍정적 효과를, 0보다 작으면 부정적 효과를 나타냅니다.

3. **신뢰 구간**: 각 연구의 효과 크기 주위의 수평선은 95% 신뢰 구간을 나타냅니다. 신뢰 구간이 0을 포함하지 않으면 해당 효과는 통계적으로 유의미합니다.

4. **다이아몬드**: 포레스트 플롯의 하단에 있는 다이아몬드는 모든 연구를 통합한 효과 크기와 그 신뢰 구간을 나타냅니다. 다이아몬드의 중심은 통합된 효과 크기를, 가로축의 너비는 신뢰 구간을 나타냅니다.

포레스트 플롯을 해석할 때, 효과 크기의 일관성과 신뢰 구간이 얼마나 중첩되는지를 살펴보는 것이 중요합니다. 효과 크기가 일관되고 신뢰 구간이 크게 중첩된다면, 이는 연구 결과가 일관성이 있음을 나타내며, 통합된 결과에 대한 신뢰도가 높다고 할 수 있습니다. 반대로, 효과 크기가 매우 다양하거나 신뢰 구간이 서로 겹치지 않는다면, 이는 연구 간의 큰 이질성을 나타내며, 메타 분석의 결과에 대한 신뢰도가 낮아질 수 있습니다.

## 회귀


```{r}
# 예시 데이터 생성
meta_data <- data.frame(
  study_label = c("Kim et al.", "Lee & Park", "Choi et al.", "Kwon & Kim", "Park et al."),
  effect_size = c(0.3, 0.5, 0.2, 0.6, 0.4),
  standard_error = c(0.08, 0.12, 0.06, 0.15, 0.1),
  type = c("RCT", "Non-RCT", "RCT", "RCT", "Non-RCT"),
  year = c(2010, 2012, 2015, 2013, 2011),
  n = c(80, 120, 200, 90, 150),
  country = c("Korea", "Korea", "USA", "Korea", "China"),
  quality_score = c(3, 2, 4, 3, 2),
  moderator1 = c(25.5, 30.2, 27.8, 32.1, 29.4),
  moderator2 = c(0.6, 0.5, 0.7, 0.4, 0.6),
  subgroup = c("RCT", "Non-RCT", "RCT", "RCT", "Non-RCT")  # 하위그룹 변수 추가
)

# 데이터 확인
print(meta_data)
```


네, 메타분석을 수행하는 대표적인 R 패키지인 'meta'를 사용한 코드 템플릿을 제시해 드리겠습니다.

```{r}
#| eval: true
# 필요한 패키지 로드
library(meta)

# 메타분석 모델 적합
ma_model <- metagen(
  TE = effect_size,  # 효과크기 변수
  seTE = standard_error,  # 표준오차 변수
  data = meta_data,
  studlab = study_label,  # 개별 연구 레이블 (선택사항)
  comb.fixed = FALSE,  # 변량효과 모형 사용
  prediction = TRUE  # 예측구간 계산
)

# 결과 요약
summary(ma_model)

# 숲 그림 (Forest plot) 생성
forest(ma_model, 
       leftlabs = c("Study", "Effect Size [95% CI]"),
       leftcols = c("studlab", "TE", "seTE"))

# 깔때기 그림 (Funnel plot) 생성
funnel(ma_model)

# 이질성 검정 (Heterogeneity test)
ma_model$I2  # I^2 통계량
ma_model$tau2  # tau^2 (zwischen-Studienvarianz)
ma_model$pval.Q  # Cochran's Q 검정 p-value

# 하위그룹 분석 (Subgroup analysis)
ma_subgroup <- update(ma_model,
                      subgroup = subgroup,  # 하위그룹 변수명을 문자열로 지정
                      tau.common = TRUE)  # 하위그룹 간 tau^2 동일 가정
# summary(ma_subgroup)

# 메타회귀분석
ma_metareg <- rma(
  yi = effect_size, 
  sei = standard_error,
  mods = ~ moderator1 + moderator2,  # 조절변인 사용
  data = meta_data,
  method = "REML"
)

# 메타회귀분석 결과 요약
summary(ma_metareg)
# summary(ma_metareg)
```

위 코드는 메타분석의 주요 단계를 다루고 있습니다. 실제 분석 시에는 데이터의 구조와 연구 목적에 맞게 코드를 수정해야 합니다. 

'meta' 패키지 외에도 'metafor', 'metaSEM' 등 다양한 R 패키지들이 메타분석을 지원하니 필요에 따라 활용해 보시기 바랍니다. 또한 메타분석 수행에는 통계적 지식이 요구되므로, 관련 문헌을 참조하거나 전문가와 상의하는 것이 도움될 수 있습니다.

### 결과 해석

```{r}
summary(ma_subgroup)
```

이 메타 분석 하위그룹(subgroup) 분석의 결과를 해석해보겠습니다:

1. **각 연구별 결과**:
   - 각 연구의 효과 크기(effect size), 95% 신뢰 구간(Confidence Interval, CI), 및 랜덤 효과 모형 하에서의 가중치(%W(random))가 제시됩니다.
   - 예를 들어, "Kim et al." 연구의 효과 크기는 0.3000이며, 95% CI는 [0.1432; 0.4568]입니다.

2. **랜덤 효과 모형 결과**:
   - 통합된 효과 크기는 0.3652, 95% CI는 [0.2305; 0.5000]입니다. 이는 통계적으로 유의미합니다 (p-value < 0.0001).
   - 예측 구간(Prediction Interval)은 [-0.0685; 0.7989]로, 새로운 연구의 효과 크기가 이 범위 내에 있을 것으로 예측됩니다.

3. **이질성 측정**:
   - `tau^2`와 `I^2`는 연구 간 이질성의 정도를 나타냅니다. `tau^2 = 0.0138`과 `I^2 = 61.6%`는 중간 정도의 이질성을 나타냅니다. 
   - `H` 값은 1.61로, 연구 간 변동성이 있다는 것을 나타냅니다.

4. **하위그룹 분석**:
   - 'RCT' 하위그룹의 통합 효과 크기는 0.3142, 95% CI는 [0.1557; 0.4726]입니다.
   - 'Non-RCT' 하위그룹의 통합 효과 크기는 0.4453, 95% CI는 [0.2337; 0.6570]입니다.
   - 'RCT' 하위그룹은 높은 이질성(I^2 = 68.5%)을, 'Non-RCT' 하위그룹은 낮은 이질성(I^2 = 0.0%)을 보입니다.

5. **하위그룹 간 차이 검정**:
   - 하위그룹 간 차이를 비교하는 검정에서는 유의미한 차이가 없음을 나타내는 p-value = 0.3309입니다.

결론적으로, 이 메타 분석 결과는 'RCT'와 'Non-RCT' 하위그룹 간에 통계적으로 유의미한 차이가 없음을 나타냅니다. 그러나 'RCT' 그룹에서는 상당한 이질성이 관찰됩니다. 이러한 결과는 연구의 설계, 집단의 특성 등 다양한 요인에 의해 영향을 받을 수 있으므로, 해석 시 주의가 필요합니다.

```{r}
summary(ma_metareg)
```


메타 회귀분석의 결과를 해석해보겠습니다:

1. **모델 적합도**:
   - `logLik`, `deviance`, `AIC`, `BIC`, `AICc`는 모델의 적합도를 나타내는 지표입니다. 이 값들은 모델의 상대적 적합도와 복잡성을 평가하는 데 사용됩니다.

2. **이질성 측정**:
   - `tau^2 = 0`: 추정된 잔여 이질성이 없음을 나타냅니다.
   - `I^2 = 0.00%`: 모든 변동성이 샘플링 오차에서 비롯된 것으로, 잔여 이질성이 없음을 나타냅니다.
   - `H^2 = 1.00`: 전체 변동성 대비 샘플링 변동성의 비율로, 1은 이질성이 없음을 의미합니다.
   - `R^2 = 100.00%`: 조절변인이 이질성을 완전히 설명한다고 해석됩니다.

3. **잔여 이질성 검정**:
   - `QE(df = 2) = 0.3009`, `p-val = 0.8603`: 잔여 이질성이 통계적으로 유의하지 않음을 나타냅니다.

4. **조절변인의 효과**:
   - `QM(df = 2) = 10.1170`, `p-val = 0.0064`: 조절변인이 통계적으로 유의미한 영향을 미친다는 것을 나타냅니다.

5. **모델 결과**:
   - `moderator1`: 추정치가 0.0149, p-val = 0.5517로, 이 변수의 효과는 통계적으로 유의하지 않습니다.
   - `moderator2`: 추정치가 -1.2222, p-val = 0.0212로, 이 변수는 통계적으로 유의한 영향을 미칩니다. 특히, 이 변수의 영향은 부정적인 것으로 나타납니다.

결론적으로, 메타 회귀분석 결과는 `moderator2`가 통계적으로 유의미한 부정적인 영향을 미치는 반면, `moderator1`의 영향은 통계적으로 유의하지 않음을 나타냅니다. 또한, 이 모델은 연구 간의 이질성을 완전히 설명하는 것으로 나타납니다.